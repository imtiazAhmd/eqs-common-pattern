{% extends "base.njk" %}

{% block content %}
<div class="govuk-width-container">
  <main class="govuk-main-wrapper" id="main-content" role="main">
    <h1 class="govuk-heading-xl">Visual Form Builder</h1>
    
    <div class="govuk-tabs" data-module="govuk-tabs">
      <h2 class="govuk-tabs__title">Contents</h2>
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
          <a class="govuk-tabs__tab" href="#build">
            Build Form
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#navigation">
            Navigation Rules
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#preview">
            JSON Preview
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#import">
            Import/Export
          </a>
        </li>
      </ul>

      <!-- Build Tab -->
      <div class="govuk-tabs__panel" id="build">
        <form id="form-builder-form">
          <!-- Form Title -->
          <div class="govuk-form-group">
            <label class="govuk-label govuk-label--l" for="form-title">
              Form Title
            </label>
            <input class="govuk-input govuk-!-width-two-thirds" id="form-title" name="formTitle" type="text" required>
          </div>

          <!-- Form Description -->
          <div class="govuk-form-group">
            <label class="govuk-label govuk-label--m" for="form-description">
              Form Description
            </label>
            <textarea class="govuk-textarea" id="form-description" name="formDescription" rows="3"></textarea>
          </div>

          <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

          <!-- Steps Container -->
          <div id="steps-container">
            <h2 class="govuk-heading-l">Form Steps</h2>
            <div id="steps-list"></div>
            
            <button type="button" class="govuk-button govuk-button--secondary" id="add-step-btn">
              Add Step
            </button>
          </div>

          <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

          <!-- Action Buttons -->
          <div class="govuk-button-group">
            <button type="button" class="govuk-button" id="set-nav-rules-btn">
              Set Navigation Rules
            </button>
          </div>
        </form>

        <!-- Validation Results -->
        <div id="validation-results" class="govuk-!-margin-top-6" style="display: none;"></div>
      </div>

      <!-- Navigation Rules Tab -->
      <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="navigation">
        <h2 class="govuk-heading-l">Global Conditional Navigation</h2>
        
        <div class="govuk-inset-text">
          <p>Configure cross-step navigation rules. When all conditions in a rule match, the user will navigate to the specified target step.</p>
          <p class="govuk-body-s"><strong>How it works:</strong> All conditions within a rule must match (AND logic). The first matching rule is used.</p>
        </div>

        <div id="global-nav-rules-container">
          <!-- Validation Results for Navigation -->
          <div id="nav-validation-results" class="govuk-!-margin-bottom-6" style="display: none;"></div>

          <div id="global-nav-rules-list"></div>
          
          <button type="button" class="govuk-button govuk-button--secondary" id="add-global-nav-rule-btn">
            Add Navigation Rule
          </button>
          
          <button type="button" class="govuk-button govuk-button--secondary" id="validate-navigation-btn">
            Validate Navigation Rules
          </button>
        </div>

        <div class="govuk-warning-text" id="navigation-warnings" style="display: none;">
          <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
          <strong class="govuk-warning-text__text">
            <span class="govuk-visually-hidden">Warning</span>
            <pre id="navigation-warning-message" style="white-space: pre-wrap; font-family: inherit;"></pre>
          </strong>
        </div>
      </div>

      <!-- JSON Preview Tab -->
      <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="preview">
        <h2 class="govuk-heading-l">JSON Configuration Preview</h2>
        <div class="govuk-form-group">
          <button type="button" class="govuk-button govuk-button--secondary" id="update-preview-btn">
            Update Preview
          </button>
          <button type="button" class="govuk-button govuk-button--secondary" id="copy-json-btn">
            Copy JSON
          </button>
        </div>
        <pre id="json-preview" class="form-builder-json-preview"><code></code></pre>
      </div>

      <!-- Import/Export Tab -->
      <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="import">
        <h2 class="govuk-heading-l">Import/Export Configuration</h2>
        
        <!-- Export Section -->
        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--m" for="export-filename">
            Export Filename
          </label>
          <div class="govuk-hint">
            Use lowercase letters, numbers, hyphens, and underscores only
          </div>
          <div style="display: flex;">
          <input class="govuk-input govuk-!-width-one-half" id="export-filename" name="exportFilename" type="text" placeholder="my-form">
          <button type="button" class="govuk-button govuk-!-margin-left-2" id="save-to-server-btn">
            Save to Server
          </button>
          <button type="button" class="govuk-button govuk-button--secondary govuk-!-margin-left-2" id="download-json-btn">
            Download JSON
          </button>
          </div>
        </div>

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

        <!-- Import Section -->
        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--m" for="import-json">
            Import JSON Configuration
          </label>
          <div class="govuk-hint">
            Paste your JSON configuration here to import it
          </div>
          <textarea class="govuk-textarea" id="import-json" name="importJson" rows="10"></textarea>
          <button type="button" class="govuk-button govuk-!-margin-top-2" id="import-json-btn">
            Import Configuration
          </button>
        </div>

        {% if existingForms.length > 0 %}
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
        
        <!-- Load Existing Forms -->
        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--m" for="existing-forms-select">
            Load Existing Form
          </label>
          <select class="govuk-select govuk-!-width-one-half" id="existing-forms-select">
            <option value="">Select a form...</option>
            {% for form in existingForms %}
            <option value="{{ form.id }}">{{ form.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="govuk-button govuk-button--secondary govuk-!-margin-left-2" id="load-existing-btn">
            Load Form
          </button>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Notification Banner (hidden by default) -->
    <div id="notification-banner" class="govuk-notification-banner" role="region" style="display: none;">
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="notification-banner-title">
          Important
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <p class="govuk-notification-banner__heading" id="notification-message">
          <!-- Message will be inserted here -->
        </p>
      </div>
    </div>
  </main>
</div>

<!-- Step Template (Hidden) -->
<template id="step-template">
  <div class="form-builder-step govuk-!-margin-bottom-6" data-step-index="">
    <div class="govuk-summary-card">
      <div class="govuk-summary-card__title-wrapper">
        <h2 class="govuk-summary-card__title">Step <span class="step-number"></span></h2>
        <ul class="govuk-summary-card__actions">
          <li class="govuk-summary-card__action">
            <a class="move-step-up" href="#" role="button">Move up</a>
          </li>
          <li class="govuk-summary-card__action">
            <a class="move-step-down" href="#" role="button">Move down</a>
          </li>
          <li class="govuk-summary-card__action">
            <a class="delete-step" href="#" role="button">Delete</a>
          </li>
        </ul>
      </div>
      <div class="govuk-summary-card__content">
        <div class="govuk-form-group">
          <label class="govuk-label" for="">Step ID</label>
          <div class="govuk-hint">Unique identifier (lowercase, underscores, no spaces)</div>
          <input class="govuk-input step-id" type="text" required>
        </div>

        <div class="govuk-checkboxes govuk-checkboxes--small govuk-!-margin-bottom-4">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input step-is-termination" type="checkbox">
            <label class="govuk-label govuk-checkboxes__label">
              This is a termination step
            </label>
          </div>
        </div>

        <div class="termination-step-config" style="display: none;">
          <div class="govuk-form-group">
            <label class="govuk-label" for="">Termination Step Title</label>
            <input class="govuk-input step-title" type="text">
          </div>

          <div class="govuk-form-group">
            <label class="govuk-label" for="">Description</label>
            <textarea class="govuk-textarea step-description" rows="3"></textarea>
          </div>

          <div class="govuk-checkboxes govuk-checkboxes--small govuk-!-margin-bottom-2">
            <div class="govuk-checkboxes__item">
              <input class="govuk-checkboxes__input step-description-html" type="checkbox">
              <label class="govuk-label govuk-checkboxes__label">
                Render description as HTML
              </label>
            </div>
          </div>

          <div class="govuk-form-group">
            <label class="govuk-label" for="">Description CSS Class (optional)</label>
            <input class="govuk-input step-description-class" type="text" placeholder="govuk-!-font-weight-bold">
          </div>

          <div class="govuk-form-group">
            <label class="govuk-label" for="">Button Text</label>
            <div class="govuk-hint">Default: "Return to form list"</div>
            <input class="govuk-input step-button-text" type="text" placeholder="Return to form list">
          </div>

          <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
        </div>

        <div class="regular-step-content">
          <h3 class="govuk-heading-m">Fields</h3>
          <div class="fields-list"></div>
          <button type="button" class="govuk-button govuk-button--secondary govuk-button--small add-field-btn">
            Add Field
          </button>

          <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

          <details class="govuk-details">
            <summary class="govuk-details__summary">
              <span class="govuk-details__summary-text">
                Conditional Navigation (Optional)
              </span>
            </summary>
            <div class="govuk-details__text">
              <p class="govuk-body-s">Define step routing based on user answers. Leave empty for sequential navigation.</p>
              
              <div class="conditional-navigation-list"></div>
              
              <button type="button" class="govuk-button govuk-button--secondary govuk-button--small add-conditional-nav-btn">
                Add Conditional Rule
              </button>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Field Template (Hidden) -->
<template id="field-template">
  <div class="form-builder-field govuk-!-margin-bottom-4" data-field-index="">
    <div class="govuk-summary-card">
      <div class="govuk-summary-card__title-wrapper">
        <h4 class="govuk-summary-card__title">Field <span class="field-number"></span></h4>
        <ul class="govuk-summary-card__actions">
          <li class="govuk-summary-card__action">
            <a class="move-field-up" href="#" role="button">Move up</a>
          </li>
          <li class="govuk-summary-card__action">
            <a class="move-field-down" href="#" role="button">Move down</a>
          </li>
          <li class="govuk-summary-card__action">
            <a class="delete-field" href="#" role="button">Delete</a>
          </li>
        </ul>
      </div>
      <div class="govuk-summary-card__content">
        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--s">Field Type</label>
          <select class="govuk-select field-type" required>
            <option value="">Select type...</option>
            <option value="text">Text Input</option>
            <option value="textarea">Text Area</option>
            <option value="radio">Radio Buttons</option>
            <option value="checkboxes">Checkboxes</option>
            <option value="select">Dropdown Select</option>
            <option value="date">Date Input</option>
          </select>
        </div>

        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--s">Field Name</label>
          <div class="govuk-hint">Variable name (lowercase, underscores, no spaces)</div>
          <input class="govuk-input field-name" type="text" required>
        </div>

        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--s">Question Text</label>
          <input class="govuk-input field-question" type="text" required>
        </div>

        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--s">Hint Text</label>
          <input class="govuk-input field-hint" type="text">
        </div>

        <div class="govuk-checkboxes govuk-checkboxes--small govuk-!-margin-bottom-2">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input field-hint-html" type="checkbox">
            <label class="govuk-label govuk-checkboxes__label">
              Render hint as HTML
            </label>
          </div>
        </div>

        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--s">Hint CSS Class (optional)</label>
          <input class="govuk-input field-hint-class" type="text" placeholder="govuk-hint--compact">
        </div>

        <div class="govuk-checkboxes govuk-checkboxes--small">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input field-required" type="checkbox">
            <label class="govuk-label govuk-checkboxes__label">
              Required field
            </label>
          </div>
        </div>

        <div class="govuk-form-group field-options-group" style="display: none;">
          <label class="govuk-label govuk-label--s">Options</label>
          
          <div class="govuk-checkboxes govuk-checkboxes--small govuk-!-margin-bottom-2">
            <div class="govuk-checkboxes__item">
              <input class="govuk-checkboxes__input field-use-custom-values" type="checkbox">
              <label class="govuk-label govuk-checkboxes__label">
                Use custom values (specify different value and display text)
              </label>
            </div>
          </div>

          <div class="field-simple-options" style="display: block;">
            <div class="govuk-hint">One option per line (e.g., Yes, No, Maybe)</div>
            <textarea class="govuk-textarea field-options" rows="4"></textarea>
          </div>

          <div class="field-custom-options" style="display: none;">
            <div class="govuk-hint">Add options with custom values and display text</div>
            <div class="custom-options-list"></div>
            <button type="button" class="govuk-button govuk-button--secondary govuk-button--small add-custom-option-btn">
              Add Option
            </button>
          </div>
        </div>

        <div class="govuk-form-group field-api-options-group" style="display: none;">
          <div class="govuk-checkboxes govuk-checkboxes--small govuk-!-margin-bottom-4">
            <div class="govuk-checkboxes__item">
              <input class="govuk-checkboxes__input field-use-api-options" type="checkbox">
              <label class="govuk-label govuk-checkboxes__label">
                Populate options from API
              </label>
            </div>
          </div>

          <div class="field-api-config-group" style="display: none;">
            <div class="govuk-form-group">
              <label class="govuk-label govuk-label--s">API Endpoint</label>
              <div class="govuk-hint">Path relative to base URL (e.g., /all)</div>
              <input class="govuk-input field-api-endpoint" type="text" placeholder="/all">
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label govuk-label--s">Query Parameters (optional)</label>
              <div class="govuk-hint">Example: fields=name or fields=name&status=active</div>
              <input class="govuk-input field-api-params" type="text" placeholder="fields=name">
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label govuk-label--s">Data Path (optional)</label>
              <div class="govuk-hint">Path to array in response (e.g., results, data.items) - leave empty if root is array</div>
              <input class="govuk-input field-api-data-path" type="text" placeholder="results">
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label govuk-label--s">Value Path</label>
              <div class="govuk-hint">Dot notation path to value (e.g., name.common)</div>
              <input class="govuk-input field-api-value-path" type="text" placeholder="name.common">
            </div>

            <div class="govuk-form-group">
              <label class="govuk-label govuk-label--s">Label Path</label>
              <div class="govuk-hint">Dot notation path to label (e.g., name.common)</div>
              <input class="govuk-input field-api-label-path" type="text" placeholder="name.common">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Conditional Navigation Rule Template (Hidden) -->
<template id="conditional-nav-template">
  <div class="conditional-nav-rule govuk-!-margin-bottom-3" data-nav-index="">
    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">Field Name</label>
      <input class="govuk-input nav-field-name" type="text" placeholder="e.g., applying_for_other">
    </div>
    
    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">When Value Is</label>
      <input class="govuk-input nav-field-value" type="text" placeholder="e.g., Yes">
    </div>
    
    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">Go To Step ID</label>
      <input class="govuk-input nav-target-step" type="text" placeholder="e.g., representative_details">
    </div>
    
    <button type="button" class="govuk-button govuk-button--warning govuk-button--small delete-nav-rule">
      Remove Rule
    </button>
    
    <hr class="govuk-section-break govuk-section-break--m">
  </div>
</template>

<!-- Custom Option Template (Hidden) -->
<template id="custom-option-template">
  <div class="custom-option-item govuk-!-margin-bottom-3" data-option-index="">
    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">Display Text</label>
      <input class="govuk-input option-text" type="text" placeholder="e.g., Criminal Law">
    </div>
    
    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">Value</label>
      <div class="govuk-hint">Auto-generated from text, or enter custom value</div>
      <input class="govuk-input option-value" type="text" placeholder="e.g., criminal_law">
    </div>
    
    <button type="button" class="govuk-button govuk-button--warning govuk-button--small delete-custom-option">
      Remove Option
    </button>
    
    <hr class="govuk-section-break govuk-section-break--m">
  </div>
</template>

<!-- Global Navigation Rule Template (Hidden) -->
<template id="global-nav-rule-template">
  <div class="global-nav-rule govuk-!-margin-bottom-6" data-rule-index="">
    <div class="govuk-summary-card">
      <div class="govuk-summary-card__title-wrapper">
        <h3 class="govuk-summary-card__title">Rule <span class="rule-number"></span></h3>
        <ul class="govuk-summary-card__actions">
          <li class="govuk-summary-card__action">
            <a class="delete-global-nav-rule" href="#" role="button">Delete</a>
          </li>
        </ul>
      </div>
      <div class="govuk-summary-card__content">
        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--s">Rule ID</label>
          <div class="govuk-hint">Unique identifier (e.g., urgent_criminal_case)</div>
          <input class="govuk-input global-nav-rule-id" type="text" required>
        </div>

        <h4 class="govuk-heading-s">Conditions (all must match)</h4>
        <div class="global-nav-conditions-list"></div>
        
        <button type="button" class="govuk-button govuk-button--secondary govuk-button--small add-global-nav-condition-btn">
          Add Condition
        </button>

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

        <div class="govuk-form-group">
          <label class="govuk-label govuk-label--s">Target Step ID</label>
          <div class="govuk-hint">Step to navigate to when all conditions match</div>
          <select class="govuk-select global-nav-target-step" required>
            <option value="">Select target step...</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Global Navigation Condition Template (Hidden) -->
<template id="global-nav-condition-template">
  <div class="global-nav-condition govuk-!-margin-bottom-4" data-condition-index="">
    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">Step</label>
      <select class="govuk-select condition-step-id" required>
        <option value="">Select step...</option>
      </select>
    </div>

    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">Field</label>
      <select class="govuk-select condition-field-name" required disabled>
        <option value="">Select step first...</option>
      </select>
    </div>

    <div class="govuk-form-group">
      <label class="govuk-label govuk-label--s">Value</label>
      <input class="govuk-input condition-value" type="text" placeholder="Expected value" required>
    </div>

    <button type="button" class="govuk-button govuk-button--warning govuk-button--small delete-global-nav-condition">
      Remove Condition
    </button>

    <hr class="govuk-section-break govuk-section-break--m">
  </div>
</template>

<input type="hidden" name="_csrf" value="{{ csrfToken }}">

<link rel="stylesheet" href="/css/form-builder.css">
<script src="/js/form-builder.js" defer></script>
{% endblock %}

