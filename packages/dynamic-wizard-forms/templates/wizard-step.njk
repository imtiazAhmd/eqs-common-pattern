{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "./form-field.njk" import renderFormField %}

<!DOCTYPE html>
<html lang="en" class="govuk-template">
<head>
  <meta charset="utf-8">
  <title>{{ stepTitle }} - {{ formTitle }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/govuk-frontend/govuk/all.css">
</head>
<body class="govuk-template__body">
  <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

  <div class="govuk-width-container">
    {% if backLink %}
      {{ govukBackLink({
        text: backLink.text,
        href: backLink.href
      }) }}
    {% endif %}

    <main class="govuk-main-wrapper" id="main-content" role="main">
      {% if error %}
        {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: error.errorSummaryList
        }) }}
      {% endif %}

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

          {% if progressIndicator %}
            <!-- Progress indicator -->
            <div class="govuk-!-margin-bottom-6">
              <p class="govuk-body-s govuk-!-margin-bottom-2">
                Step {{ currentStep }} of {{ totalSteps }}
              </p>
              <div class="govuk-progress-bar" style="width: 100%; height: 8px; background-color: #f3f2f1; border-radius: 4px;">
                <div style="width: {{ (currentStep / totalSteps) * 100 }}%; height: 100%; background-color: #1d70b8; border-radius: 4px;"></div>
              </div>
            </div>
          {% endif %}

          <h1 class="govuk-heading-xl">{{ stepTitle }}</h1>

          {% if stepDescription %}
            <p class="govuk-body-l">{{ stepDescription }}</p>
          {% endif %}

          {% if isUrgentStep %}
            <div class="govuk-warning-text">
              <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
              <strong class="govuk-warning-text__text">
                <span class="govuk-warning-text__assistive">Warning</span>
                This is an urgent matter requiring immediate attention.
              </strong>
            </div>
          {% endif %}

          {% if isTerminalStep %}
            <div class="govuk-notification-banner" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
              <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                  Important
                </h2>
              </div>
              <div class="govuk-notification-banner__content">
                <p class="govuk-notification-banner__heading">
                  You cannot continue with this application at this time.
                </p>
              </div>
            </div>
          {% endif %}

          <form method="post" novalidate>
            {% if csrfToken %}
              <input type="hidden" name="_csrf" value="{{ csrfToken }}">
            {% endif %}

            {% for field in formConfig %}
              {% set fieldName = field.name %}
              {% set fieldValue = formData[fieldName] %}
              {% set fieldError = error.inputErrors[fieldName] if error and error.inputErrors %}

              {{ renderFormField(field, fieldValue, fieldError, formData) }}
            {% endfor %}

            <div class="govuk-button-group">
              {% if not isFirstStep and not isTerminalStep %}
                <button type="submit" name="action" value="previous" class="govuk-button govuk-button--secondary">
                  Previous
                </button>
              {% endif %}

              {% if isTerminalStep %}
                <!-- Terminal step - no navigation buttons -->
                <p class="govuk-body">
                  {% if backLink %}
                    <a href="{{ backLink.href }}" class="govuk-link">{{ backLink.text }}</a>
                  {% else %}
                    <a href="/" class="govuk-link">Return to start</a>
                  {% endif %}
                </p>
              {% elif isUrgentStep %}
                <button type="submit" name="action" value="submit" class="govuk-button govuk-button--warning">
                  Submit urgent request
                </button>
              {% elif isLastStep %}
                <button type="submit" name="action" value="submit" class="govuk-button">
                  Submit application
                </button>
              {% else %}
                <button type="submit" name="action" value="next" class="govuk-button">
                  Save and continue
                </button>
              {% endif %}
            </div>
          </form>

        </div>
      </div>
    </main>
  </div>

  <script src="/govuk-frontend/govuk/all.js"></script>
  <script>window.GOVUKFrontend.initAll()</script>
</body>
</html>